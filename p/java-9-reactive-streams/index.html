<!doctype html><html lang=zh-Hans dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Reactive Streams æ˜¯å…·æœ‰éé˜»å¡èƒŒå‹çš„å¼‚æ­¥æµå¤„ç†æ ‡å‡†"><title>Java 9 Reactive Streams</title>
<link rel=canonical href=https://xiuwei.github.io/p/java-9-reactive-streams/><link rel=stylesheet href=/scss/style.min.8e60baf4cd3fc55968717a6e39762f4d28ed7ef6007566b6c7970ad0fe907198.css><meta property='og:title' content="Java 9 Reactive Streams"><meta property='og:description' content="Reactive Streams æ˜¯å…·æœ‰éé˜»å¡èƒŒå‹çš„å¼‚æ­¥æµå¤„ç†æ ‡å‡†"><meta property='og:url' content='https://xiuwei.github.io/p/java-9-reactive-streams/'><meta property='og:site_name' content='å“ˆçš®çš„è‡ªè¨€è‡ªè¯­'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Java'><meta property='article:tag' content='Reactive'><meta property='article:tag' content='ååº”å¼æµ'><meta property='article:published_time' content='2021-12-12T12:00:00+00:00'><meta property='article:modified_time' content='2021-12-12T12:00:00+00:00'><meta property='og:image' content='https://xiuwei.github.io/p/java-9-reactive-streams/cover.jpg'><meta name=twitter:site content="@@Willie_Lau"><meta name=twitter:creator content="@@Willie_Lau"><meta name=twitter:title content="Java 9 Reactive Streams"><meta name=twitter:description content="Reactive Streams æ˜¯å…·æœ‰éé˜»å¡èƒŒå‹çš„å¼‚æ­¥æµå¤„ç†æ ‡å‡†"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://xiuwei.github.io/p/java-9-reactive-streams/cover.jpg'><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huc21dbe1ce4b866464592b14304df5a25_40367_300x0_resize_q75_box.jpeg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/>å“ˆçš®çš„è‡ªè¨€è‡ªè¯­</a></h1><h2 class=site-description>Entities should not be multiplied unnecessarily.</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>ä¸»é¡µ</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>æ£€ç´¢</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#1æ¦‚è¿°>1.æ¦‚è¿°</a></li><li><a href=#2reactive-api-æ¦‚è§ˆ>2.Reactive API æ¦‚è§ˆ</a></li><li><a href=#3å‘å¸ƒå’Œæ¶ˆè´¹æ¶ˆæ¯>3.å‘å¸ƒå’Œæ¶ˆè´¹æ¶ˆæ¯</a></li><li><a href=#4æ¶ˆæ¯çš„è½¬æ¢>4.æ¶ˆæ¯çš„è½¬æ¢</a></li><li><a href=#5ä½¿ç”¨-subscription-æ§åˆ¶æ¶ˆæ¯å–å€¼>5.ä½¿ç”¨ Subscription æ§åˆ¶æ¶ˆæ¯å–å€¼</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/java-9-reactive-streams/><img src=/p/java-9-reactive-streams/cover_hu5459c0360c2b0cb7a147d2df0eb350ca_1105727_800x0_resize_q75_box.jpg srcset="/p/java-9-reactive-streams/cover_hu5459c0360c2b0cb7a147d2df0eb350ca_1105727_800x0_resize_q75_box.jpg 800w, /p/java-9-reactive-streams/cover_hu5459c0360c2b0cb7a147d2df0eb350ca_1105727_1600x0_resize_q75_box.jpg 1600w" width=800 height=533 loading=lazy alt="Featured image of post Java 9 Reactive Streams"></a></div><div class=article-details><header class=article-category><a href=/categories/java/>Java
</a><a href=/categories/reactive/>Reactive</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/java-9-reactive-streams/>Java 9 Reactive Streams</a></h2><h3 class=article-subtitle>Reactive Streams æ˜¯å…·æœ‰éé˜»å¡èƒŒå‹çš„å¼‚æ­¥æµå¤„ç†æ ‡å‡†</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Dec 12, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 4 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h2 id=1æ¦‚è¿°><a href=#1%e6%a6%82%e8%bf%b0>#</a>
1.æ¦‚è¿°</h2><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶ Java 9 ååº”å¼æµã€‚ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿä½¿ç”¨ Flow ç±»ï¼Œå®ƒåŒ…å«ç”¨äºæ„å»ºååº”å¼æµå¤„ç†é€»è¾‘çš„ä¸»è¦æ„å»ºå—ã€‚</p><p>Reactive Streams æ˜¯å…·æœ‰éé˜»å¡èƒŒå‹çš„å¼‚æ­¥æµå¤„ç†æ ‡å‡†ã€‚è¯¥è§„èŒƒåœ¨ <a class=link href=http://www.reactive-streams.org/ target=_blank rel=noopener>Reactive Manifesto</a> ä¸­å®šä¹‰ï¼Œå¹¶ä¸”æœ‰å¤šç§å®ç°ï¼Œä¾‹å¦‚ RxJava æˆ– Akka-Streamsã€‚</p><h2 id=2reactive-api-æ¦‚è§ˆ><a href=#2reactive-api-%e6%a6%82%e8%a7%88>#</a>
2.Reactive API æ¦‚è§ˆ</h2><p>ä¸ºäº†æ„å»º <em>Flow</em> ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‰ä¸ªä¸»è¦æŠ½è±¡å¹¶å°†å®ƒä»¬ç»„åˆæˆå¼‚æ­¥å¤„ç†é€»è¾‘ã€‚</p><p><strong>æ¯ä¸ª <em>Flow</em> éƒ½éœ€è¦å¤„ç† <em>Publisher</em> å®ä¾‹å‘å…¶å‘å¸ƒçš„äº‹ä»¶ï¼›</strong> Publisher æœ‰ä¸€ç§æ–¹æ³•â€”â€”subscribe()ã€‚</p><p><strong>æ¶ˆæ¯çš„æ¥æ”¶è€…éœ€è¦å®ç° <em>Subscriber</em> æ¥å£ã€‚</strong> é€šå¸¸ï¼Œè¿™æ˜¯æ¯ä¸ªæµå¤„ç†çš„ç»“æŸï¼Œå› ä¸ºå®ƒçš„å®ä¾‹ä¸ä¼šè¿›ä¸€æ­¥å‘é€æ¶ˆæ¯ã€‚
æˆ‘ä»¬å¯ä»¥å°†Subscriber è§†ä¸ºä¸€ä¸ªæ¥æ”¶å™¨ã€‚å®ƒæœ‰å››ä¸ªéœ€è¦é‡å†™çš„æ–¹æ³• - <em>onSubscribe()</em>ã€<em>onNext()</em>ã€<em>onError()</em> å’Œ <em>onComplete()</em>ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­è®¨è®ºè¿™äº›å†…å®¹ã€‚</p><p><strong>å¦‚æœæˆ‘ä»¬æƒ³è½¬æ¢ä¼ å…¥çš„æ¶ˆæ¯å¹¶å°†å…¶è¿›ä¸€æ­¥ä¼ é€’ç»™ä¸‹ä¸€ä¸ª<em>Subscriber</em>ï¼Œæˆ‘ä»¬éœ€è¦å®ç° <em>Processor</em> æ¥å£ã€‚</strong> å®ƒæ—¢å……å½“ Subscriber ï¼Œå› ä¸ºå®ƒæ¥æ”¶æ¶ˆæ¯ï¼Œåˆå……å½“ Publisher ï¼Œå› ä¸ºå®ƒå¤„ç†è¿™äº›æ¶ˆæ¯å¹¶å°†å…¶å‘é€ä»¥è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</p><h2 id=3å‘å¸ƒå’Œæ¶ˆè´¹æ¶ˆæ¯><a href=#3%e5%8f%91%e5%b8%83%e5%92%8c%e6%b6%88%e8%b4%b9%e6%b6%88%e6%81%af>#</a>
3.å‘å¸ƒå’Œæ¶ˆè´¹æ¶ˆæ¯</h2><p>å‡è®¾æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªç®€å•çš„ <em>Flow</em>ï¼Œå…¶ä¸­ä¸€ä¸ªå‘å¸ƒæ¶ˆæ¯çš„ <em>Publisher</em> å’Œä¸€ä¸ªç®€å•çš„ <em>Subscriber</em> åœ¨æ¶ˆæ¯åˆ°è¾¾æ—¶æ¶ˆè´¹æ¶ˆæ¯ - ä¸€æ¬¡ä¸€ä¸ªã€‚</p><p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <em>EndSubscriber</em> ç±»ã€‚æˆ‘ä»¬éœ€è¦å®ç° <em>Subscriber</em> æ¥å£ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é‡å†™æ‰€éœ€æ–¹æ³•ã€‚</p><p><em>onSubscribe()</em> æ–¹æ³•åœ¨å¤„ç†å¼€å§‹ä¹‹å‰è°ƒç”¨ã€‚<em>Subscription</em> (è®¢é˜…)çš„å®ä¾‹ä½œä¸ºå‚æ•°ä¼ é€’ã€‚å®ƒæ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶ <em>Subscriber</em> å’Œ <em>Publisher</em> ä¹‹é—´çš„æ¶ˆæ¯æµçš„ç±»ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MySubscriber</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Flow</span><span class=p>.</span><span class=na>Subscriber</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Flow</span><span class=p>.</span><span class=na>Subscription</span><span class=w> </span><span class=n>subscription</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>consumedElements</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onSubscribe</span><span class=p>(</span><span class=n>Flow</span><span class=p>.</span><span class=na>Subscription</span><span class=w> </span><span class=n>subscription</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>subscription</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>subscription</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>subscription</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æˆ‘ä»¬è¿˜åˆå§‹åŒ–äº†ä¸€ä¸ªç©ºçš„ ConsumerElements åˆ—è¡¨ï¼Œå®ƒå°†åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å®ç° Subscriber æ¥å£çš„å…¶ä½™æ–¹æ³•ã€‚è¿™é‡Œçš„ä¸»è¦æ–¹æ³•æ˜¯ onNext() â€“ æ¯å½“ Publisher å‘å¸ƒæ–°æ¶ˆæ¯æ—¶éƒ½ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onNext</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>item</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¥æ”¶åˆ°æ•°æ® ï¼š &#34;</span><span class=o>+</span><span class=n>item</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>consumedElements</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>item</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>subscription</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯·æ³¨æ„ï¼Œå½“æˆ‘ä»¬åœ¨ onSubscribe() æ–¹æ³•ä¸­å¯åŠ¨è®¢é˜…å¹¶å¤„ç†æ¶ˆæ¯æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨è®¢é˜…ä¸Šçš„ request() æ–¹æ³•æ¥è¡¨æ˜å½“å‰ Subscriber å·²å‡†å¤‡å¥½æ¶ˆè´¹æ›´å¤šæ¶ˆæ¯ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦å®ç° onError() â€”â€”æ¯å½“å¤„ç†è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶å°±ä¼šè°ƒç”¨å®ƒï¼Œä»¥åŠ onComplete() â€”â€”å½“ Publisher å…³é—­æ—¶è°ƒç”¨ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onError</span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>throwable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>throwable</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onComplete</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;MySubscriber Complete!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è®©æˆ‘ä»¬ä¸ºå¤„ç†æµç¨‹ç¼–å†™ä¸€ä¸ªæµ‹è¯•ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ SubmissionPublisher ç±»â€”â€”ä¸€ä¸ªæ¥è‡ª java.util.concurrent çš„æ„é€ â€”â€”å®ƒå®ç°äº†
Publisher æ¥å£ã€‚</p><p>æˆ‘ä»¬å°†å‘ Publisher æäº¤ N ä¸ªå…ƒç´ â€”â€”æˆ‘ä»¬çš„æœ€ç»ˆ Subscriber å°†æ”¶åˆ°è¿™äº›å…ƒç´ ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>whenSubscribeToIt_thenShouldConsumeAll</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SubmissionPublisher</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>publisher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SubmissionPublisher</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MySubscriber</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>subscriber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MySubscriber</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>publisher</span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=n>subscriber</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>items</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>List</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;x&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;2&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;x&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;3&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;x&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertEquals</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>publisher</span><span class=p>.</span><span class=na>getNumberOfSubscribers</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>items</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>publisher</span><span class=p>::</span><span class=n>submit</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>publisher</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>await</span><span class=p>().</span><span class=na>atMost</span><span class=p>(</span><span class=n>1000</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>until</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>subscriber</span><span class=p>.</span><span class=na>consumedElements</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>items</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æ­£åœ¨ EndSubscriber å®ä¾‹ä¸Šè°ƒç”¨ close() æ–¹æ³•ã€‚å®ƒå°†åœ¨ç»™å®šPublisher çš„æ¯ä¸ª Subscriber ä¸Šè°ƒç”¨ä¸‹é¢çš„ onComplete() å›è°ƒã€‚</p><p>è¿è¡Œè¯¥ç¨‹åºå°†äº§ç”Ÿä»¥ä¸‹è¾“å‡ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>æ¥æ”¶åˆ°æ•°æ® ï¼š <span class=m>1</span>
</span></span><span class=line><span class=cl>æ¥æ”¶åˆ°æ•°æ® ï¼š x
</span></span><span class=line><span class=cl>æ¥æ”¶åˆ°æ•°æ® ï¼š <span class=m>2</span>
</span></span><span class=line><span class=cl>æ¥æ”¶åˆ°æ•°æ® ï¼š x
</span></span><span class=line><span class=cl>æ¥æ”¶åˆ°æ•°æ® ï¼š <span class=m>3</span>
</span></span><span class=line><span class=cl>æ¥æ”¶åˆ°æ•°æ® ï¼š x
</span></span><span class=line><span class=cl>MySubscriber Complete!
</span></span></code></pre></td></tr></table></div></div><h2 id=4æ¶ˆæ¯çš„è½¬æ¢><a href=#4%e6%b6%88%e6%81%af%e7%9a%84%e8%bd%ac%e6%8d%a2>#</a>
4.æ¶ˆæ¯çš„è½¬æ¢</h2><p>å‡è®¾æˆ‘ä»¬æƒ³è¦åœ¨ Publisher å’Œ Subscriber ä¹‹é—´æ„å»ºç±»ä¼¼çš„é€»è¾‘ï¼Œä½†ä¹Ÿåº”ç”¨ä¸€äº›æ¶ˆæ¯è½¬æ¢ã€‚</p><p>æˆ‘ä»¬å°†åˆ›å»ºå®ç° Processor å¹¶æ‰©å±• SubmissionPublisher çš„ TransformProcessor ç±» - è¿™å°†åŒæ—¶æ˜¯ Publisher å’Œ Subscriberã€‚</p><p>æˆ‘ä»¬å°†ä¼ å…¥ä¸€ä¸ªå°†è¾“å…¥è½¬æ¢ä¸ºè¾“å‡ºçš„ <code>Function</code>ï¼ˆå‡½æ•°ï¼‰ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TransformProcessor</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>SubmissionPublisher</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Flow</span><span class=p>.</span><span class=na>Processor</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Function</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>function</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Flow</span><span class=p>.</span><span class=na>Subscription</span><span class=w> </span><span class=n>subscription</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>TransformProcessor</span><span class=p>(</span><span class=n>Function</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>function</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>function</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>function</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onSubscribe</span><span class=p>(</span><span class=n>Flow</span><span class=p>.</span><span class=na>Subscription</span><span class=w> </span><span class=n>subscription</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>subscription</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>subscription</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>subscription</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onNext</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>item</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>submit</span><span class=p>(</span><span class=n>function</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>item</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>subscription</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onError</span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onComplete</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æˆ‘ä»¬å¿«é€Ÿç¼–å†™ä¸€ä¸ªå°† Publisher å‘é€çš„ String å…ƒç´ è½¬æ¢ä¸º Integer å…ƒç´ çš„å•å…ƒæµ‹è¯•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>whenSubscribeAndTransformElements_thenShouldConsumeAll</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SubmissionPublisher</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>publisher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SubmissionPublisher</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TransformProcessor</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>transformProcessor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformProcessor</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>Integer</span><span class=p>::</span><span class=n>parseInt</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MySubscriber</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>subscriber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MySubscriber</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>items</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>List</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;2&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;3&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>expectedResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>List</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>,</span><span class=w> </span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>publisher</span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=n>transformProcessor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>transformProcessor</span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=n>subscriber</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>items</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>publisher</span><span class=p>::</span><span class=n>submit</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>publisher</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>await</span><span class=p>().</span><span class=na>atMost</span><span class=p>(</span><span class=n>1000</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>until</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>assertIterableEquals</span><span class=p>(</span><span class=n>expectedResult</span><span class=p>,</span><span class=w> </span><span class=n>subscriber</span><span class=p>.</span><span class=na>consumedElements</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=n>subscriber</span><span class=p>.</span><span class=na>consumedElements</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>expectedResult</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯·æ³¨æ„ï¼Œè°ƒç”¨åŸºç¡€ Publisher ä¸Šçš„ close() æ–¹æ³•å°†å¯¼è‡´è°ƒç”¨ TransformProcessor ä¸Šçš„ onComplete() æ–¹æ³•ã€‚</p><p>è¯·è®°ä½ï¼Œå¤„ç†é“¾ä¸­çš„æ‰€æœ‰ Publisher éƒ½éœ€è¦ä»¥è¿™ç§æ–¹å¼å…³é—­ã€‚</p><h2 id=5ä½¿ç”¨-subscription-æ§åˆ¶æ¶ˆæ¯å–å€¼><a href=#5%e4%bd%bf%e7%94%a8-subscription-%e6%8e%a7%e5%88%b6%e6%b6%88%e6%81%af%e5%8f%96%e5%80%bc>#</a>
5.ä½¿ç”¨ Subscription æ§åˆ¶æ¶ˆæ¯å–å€¼</h2><p>å‡è®¾æˆ‘ä»¬åªæƒ³ä½¿ç”¨ Subscription ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåº”ç”¨ä¸€äº›é€»è¾‘å¹¶å®Œæˆå¤„ç†ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ request() æ–¹æ³•æ¥å®ç°è¿™ä¸€ç‚¹ã€‚</p><p>è®©æˆ‘ä»¬ä¿®æ”¹ MySubscriber ä»¥ä»…æ¶ˆè€— N æ¡æ¶ˆæ¯ã€‚æˆ‘ä»¬å°†è¯¥æ•°å­—ä½œä¸º howMuchMessagesConsume çš„æ„é€ å‡½æ•°å‚æ•°è¿›è¡Œä¼ é€’ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MySubscriber</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Flow</span><span class=p>.</span><span class=na>Subscriber</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Flow</span><span class=p>.</span><span class=na>Subscription</span><span class=w> </span><span class=n>subscription</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AtomicInteger</span><span class=w> </span><span class=n>howMuchMessagesConsume</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>consumedElements</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>MySubscriber</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>howMuchMessagesConsume</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>howMuchMessagesConsume</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicInteger</span><span class=p>(</span><span class=n>howMuchMessagesConsume</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onSubscribe</span><span class=p>(</span><span class=n>Flow</span><span class=p>.</span><span class=na>Subscription</span><span class=w> </span><span class=n>subscription</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>subscription</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>subscription</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>subscription</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onNext</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>item</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>howMuchMessagesConsume</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;æ¥æ”¶åˆ°æ•°æ® ï¼š &#34;</span><span class=o>+</span><span class=n>item</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>howMuchMessagesConsume</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>consumedElements</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>item</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>subscription</span><span class=p>.</span><span class=na>request</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onError</span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>throwable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>throwable</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onComplete</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;MySubscriber Complete!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œå®ç°åªä½¿ç”¨ Subscription ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>whenRequestForOnlyOneElement_thenShouldConsumeOne</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SubmissionPublisher</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>publisher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SubmissionPublisher</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MySubscriber</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>subscriber</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MySubscriber</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>publisher</span><span class=p>.</span><span class=na>subscribe</span><span class=p>(</span><span class=n>subscriber</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>items</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>List</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;x&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;2&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;x&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;3&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;x&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>expected</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>List</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=s>&#34;1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertEquals</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>publisher</span><span class=p>.</span><span class=na>getNumberOfSubscribers</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>items</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>publisher</span><span class=p>::</span><span class=n>submit</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>publisher</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>await</span><span class=p>().</span><span class=na>atMost</span><span class=p>(</span><span class=n>1000</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>until</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>assertIterableEquals</span><span class=p>(</span><span class=n>expected</span><span class=p>,</span><span class=w> </span><span class=n>subscriber</span><span class=p>.</span><span class=na>consumedElements</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=n>expected</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>subscriber</span><span class=p>.</span><span class=na>consumedElements</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å°½ç®¡ Publisher æ­£åœ¨å‘å¸ƒå…­ä¸ªå…ƒç´ ï¼Œä½†æˆ‘ä»¬çš„ MySubscriber å°†ä»…æ¶ˆè€—ä¸€ä¸ªå…ƒç´ ï¼Œå› ä¸ºå®ƒå‘å‡ºåªå¤„ç†è¯¥å•ä¸ªå…ƒç´ çš„ä¿¡å·ã€‚</p><p>é€šè¿‡åœ¨ Subscriber ä¸Šä½¿ç”¨ request() æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æ›´å¤æ‚çš„èƒŒå‹ï¼ˆback-pressureï¼‰æœºåˆ¶æ¥æ§åˆ¶æ¶ˆæ¯æ¶ˆè´¹çš„é€Ÿåº¦ã€‚</p></section><footer class=article-footer><section class=article-tags><a href=/tags/java/>Java</a>
<a href=/tags/reactive/>Reactive</a>
<a href=/tags/%E5%8F%8D%E5%BA%94%E5%BC%8F%E6%B5%81/>ååº”å¼æµ</a></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>æœ€åæ›´æ–°äº Dec 12, 2021 12:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/rxjava-vs-java-flow/><div class=article-image><img src=/p/rxjava-vs-java-flow/cover.4e35880cf062523199492ac5ae68f2ae_hu5459c0360c2b0cb7a147d2df0eb350ca_4206946_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post RxJava API ä¸ Java 9 Flow API çš„åŒºåˆ«" data-key=rxjava-vs-java-flow data-hash="md5-TjWIDPBiUjGZSSrFrmjyrg=="></div><div class=article-details><h2 class=article-title>RxJava API ä¸ Java 9 Flow API çš„åŒºåˆ«</h2></div></a></article><article class=has-image><a href=/p/java-8-functional/><div class=article-image><img src=/p/java-8-functional/cover.275bf5970d2ebd16c0cefedc6611d91d_hu5459c0360c2b0cb7a147d2df0eb350ca_1307901_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Java 8 å‡½æ•°å¼æ¥å£åˆè¯†" data-key=java-8-functional data-hash="md5-J1v1lw0uvRbAzv7cZhHZHQ=="></div><div class=article-details><h2 class=article-title>Java 8 å‡½æ•°å¼æ¥å£åˆè¯†</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//xiuwei.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 å“ˆçš®çš„è‡ªè¨€è‡ªè¯­</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script>document.querySelectorAll(".powerby").forEach(e=>{e.style.display="none"})</script></body></html>