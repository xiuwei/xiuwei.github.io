<!doctype html><html lang=zh-Hans dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="在项目开发中，记录日志是一个非常高频的操作。日志包提供了各种接口，可以让我们根据需要记录日志，但是在记录日志时也需要遵循一定的规范。"><title>日志规范</title>
<link rel=canonical href=https://xiuwei.github.io/p/log-specification/><link rel=stylesheet href=/scss/style.min.8e60baf4cd3fc55968717a6e39762f4d28ed7ef6007566b6c7970ad0fe907198.css><meta property='og:title' content="日志规范"><meta property='og:description' content="在项目开发中，记录日志是一个非常高频的操作。日志包提供了各种接口，可以让我们根据需要记录日志，但是在记录日志时也需要遵循一定的规范。"><meta property='og:url' content='https://xiuwei.github.io/p/log-specification/'><meta property='og:site_name' content='哈皮的自言自语'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Logs'><meta property='article:tag' content='Golang'><meta property='article:published_time' content='2024-04-02T19:00:00+00:00'><meta property='article:modified_time' content='2024-04-02T19:00:00+00:00'><meta property='og:image' content='https://xiuwei.github.io/p/log-specification/cover.jpg'><meta name=twitter:site content="@@Willie_Lau"><meta name=twitter:creator content="@@Willie_Lau"><meta name=twitter:title content="日志规范"><meta name=twitter:description content="在项目开发中，记录日志是一个非常高频的操作。日志包提供了各种接口，可以让我们根据需要记录日志，但是在记录日志时也需要遵循一定的规范。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://xiuwei.github.io/p/log-specification/cover.jpg'><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huc21dbe1ce4b866464592b14304df5a25_40367_300x0_resize_q75_box.jpeg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>哈皮的自言自语</a></h1><h2 class=site-description>Entities should not be multiplied unnecessarily.</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>检索</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#前言>前言</a></li><li><a href=#日志打印规范>日志打印规范</a><ol><li><a href=#强制必须遵循的规范>【强制】必须遵循的规范]</a></li><li><a href=#建议建议遵循的规范>【建议】建议遵循的规范</a></li></ol></li><li><a href=#选择合适的日志级别>选择合适的日志级别</a></li><li><a href=#日志打印时机>日志打印时机</a><ol><li><a href=#建议打印时机>建议打印时机</a></li><li><a href=#不建议打印时机>不建议打印时机</a></li></ol></li><li><a href=#日志级别设置规范>日志级别设置规范</a></li><li><a href=#日志格式设置规范>日志格式设置规范</a></li><li><a href=#日志打印检查>日志打印检查</a></li><li><a href=#其他日志规范参考>其他日志规范参考</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/log-specification/><img src=/p/log-specification/cover_hu5459c0360c2b0cb7a147d2df0eb350ca_5422841_800x0_resize_q75_box.jpg srcset="/p/log-specification/cover_hu5459c0360c2b0cb7a147d2df0eb350ca_5422841_800x0_resize_q75_box.jpg 800w, /p/log-specification/cover_hu5459c0360c2b0cb7a147d2df0eb350ca_5422841_1600x0_resize_q75_box.jpg 1600w" width=800 height=533 loading=lazy alt="Featured image of post 日志规范"></a></div><div class=article-details><header class=article-category><a href=/categories/convention/>Convention</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/log-specification/>日志规范</a></h2><h3 class=article-subtitle>在项目开发中，记录日志是一个非常高频的操作。日志包提供了各种接口，可以让我们根据需要记录日志，但是在记录日志时也需要遵循一定的规范。</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Apr 02, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 14 分钟</time></div></footer></div></header><section class=article-content><h2 id=前言><a href=#%e5%89%8d%e8%a8%80>#</a>
前言</h2><p>如果在阅读日志时，你遇到以下问题，说明你的日志打印需要规范起来：</p><ul><li>过多或冗余的日志，干扰排障：有时候，系统可能会记录过多的日志信息，包括一些无关紧要的或冗余的信息。这会导致日志文件过大，不易于查找和分析关键的日志记录；</li><li><strong>缺乏一致性和标准化：</strong> 在多个模块或组件中，日志格式和结构可能不一致，导致日志的解析和分析困难。缺乏统一的标准化规范，使得日志的可读性和可维护性下降；</li><li>缺乏上下文信息：打印日志时，只把原始的错误打印出来，没有补充打印上下文信息，例如：请求参数、关键变量值等，导致排障困难，需要重新复现；</li><li>同一个错误层层打印：例如在 Go 简洁架构中，同一个错误日志分别在 Use Case 层和 Service 层分别打印，导致在排障时带来冗余日志干扰，还会导致程序性能下降、浪费存储空间等；</li><li>根因丢失，无法快速定位故障点：有时候，错误日志在向上传递过程中，如果做了包装，要附带一些信息，最原始的报错日志可能就会丢失，导致很难定位出错误根因。</li></ul><p>日志规范是为了提高日志的可读性、可维护性和可搜索性而制定的一系列规则和约定。将日志打印规范化，可以带来以下好处：</p><ul><li>可读性：日志规范可以定义日志的格式、结构和语义，使日志信息更易于理解和解读。统一的日志格式可以让开发人员、运维人员和其他团队成员更容易阅读和理解日志，从而更快地定位和解决问题；</li><li>可维护性：日志规范可以定义日志的级别、分类和命名规则，使日志更易于管理和维护。通过规范化的日志级别和分类，可以更好地组织和过滤日志，只关注关键的日志信息，减少冗余和无用的日志记录；</li><li>可搜索性：日志规范可以定义日志的关键字、标签和结构，使日志更易于搜索和过滤。通过定义一致的日志结构和关键字，可以使用日志分析工具或搜索引擎来快速搜索和过滤日志，以便查找特定的事件、错误或异常；</li><li>故障排查：日志规范可以帮助定位和排查故障。规范的日志格式和结构可以提供更多的上下文信息，包括时间戳、请求参数、异常堆栈等，有助于分析和理解故障现象，加快故障排查的速度和准确性；</li><li>性能优化：日志规范可以帮助识别和优化性能问题。通过规范化的日志记录和度量指标，可以更好地监控和分析系统的性能表现，发现潜在的性能瓶颈和优化机会。</li></ul><p>可以看到，日志规范是提高日志质量和效用的重要工具。通过制定和遵守日志规范，可以提升团队协作效率，加快故障排查和问题解决的速度，提高系统的可靠性和性能。</p><p>本文就来介绍下日志记录需要遵循的规范。这些日志规范分为以下 2 类：</p><ul><li>必须遵循的：这类规范是所有组件记录日志时都要遵循的规范；</li><li>建议遵循的：这些规范是根据需要选择性需要遵循的规范。</li></ul><h2 id=日志打印规范><a href=#%e6%97%a5%e5%bf%97%e6%89%93%e5%8d%b0%e8%a7%84%e8%8c%83>#</a>
日志打印规范</h2><h3 id=强制必须遵循的规范><a href=#%e5%bc%ba%e5%88%b6%e5%bf%85%e9%a1%bb%e9%81%b5%e5%be%aa%e7%9a%84%e8%a7%84%e8%8c%83>#</a>
【强制】必须遵循的规范]</h3><ul><li>所有日志均使用英文进行记录；</li><li>记录日志时，要明确日志级别，选择正确的日志级别；</li><li>打印结构化的日志，不要拼接字符串， 采用 KV 模式；</li><li>日志均以大写开头，结尾不跟 .（可以接受问号和感叹号，但不推荐），例如：log.Errorw(err, &ldquo;Failed to create lru cache&rdquo;)；</li><li>使用过去时，例如：Could not delete B 而不是 Cannot delete B；</li><li>日志信息应使用主语进行记录，当有执行主体时使用完整句子 （A could not do B），如果主体是程序本身则省略主语（Could not do B）；</li><li>日志要脱敏，禁止输出敏感的信息，例如：密码、密钥、手机号、IP 等信息；</li><li>为了方便阅读日志，日志禁止换行；</li><li>日志中不要记录无用信息，防止无用日志淹没重要信息；</li><li>日志信息要准确全面，努力做到仅凭日志就可以定位问题；</li><li>Error 日志必须记录完整的上下文信息，例如：完整输入和输出、关键变量的值等；</li><li>使用 Warn 级别记录用户输入参数错误导致的程序错误。因为我们 Error 和 Warn 级别的日志告警策略不同，在 Warn 级别打印，可以避免频繁告警；</li><li>确保日志打印语句不 Panic，例如：klog.V(4).Infof(&ldquo;Connection error: %s %s: %v&rdquo;, t.Op, t.URL, t.Err)，如果 t 是 nil 就会导致日志调用时发生 panic，会大大加大排障难度；</li><li>日志信息禁用字符串拼接，而要使用占位符。使用占位符，格式更清晰，性能更优。例如：klog.V(4).Infof(&ldquo;Get login token: %s&rdquo;, rp.Token)；</li><li>所有 Operator、Controller、Kube APIServer Style 的组件为了跟 K8S 生态保持兼容，统一使用 <a class=link href=http://k8s.io/klog/v2 target=_blank rel=noopener>k8s.io/klog/v2open in new window</a> 包。所有非 Operator、Controller、Kube APIServer Style 的组件统一使用 <a class=link href=http://github.com/superproj/onex/pkg/log target=_blank rel=noopener>github.com/superproj/onex/pkg/logopen in new window</a> 包；</li><li>当时用 <a class=link href=http://k8s.io/klog/v2 target=_blank rel=noopener>k8s.io/klog/v2open in new window</a> 记录日志时，需要遵循以下规范：<ul><li>要使用结构化的日志记录方式：klog.InfoS， klog.ErrorS。Example: klog.InfoS(&ldquo;Received HTTP request&rdquo;, &ldquo;method&rdquo;, &ldquo;GET&rdquo;, &ldquo;URL&rdquo;, &ldquo;/metrics&rdquo;, &ldquo;latency&rdquo;, time.Second);</li><li>日志级别：<ul><li>Error 级别日志使用：klog.ErrorS；</li><li>Warning 级别日志使用：klog.V(1).InfoS；</li><li>Info 级别日志使用：klog.V(2).InfoS；</li><li>Debug 级别日志使用：klog.V(4).InfoS；</li><li>Trace 级别日志使用：klog.V(5).InfoS。</li></ul></li></ul></li><li>日志键值对，值规范如下：<ul><li>优先使用klog.KObj 或 klog.KObjSlice来记录 Kubernetes 对象；<ul><li>当日志记录对象不是一个标准的 Kubernetes 资源对象时，使用klog.KRef；</li><li>当日志记录对象是单个 Kubernetes 资源对象时（例如：*v1.Pod），使用klog.KObj；</li><li>当日志记录对象是 Kubernetes 资源对象数组时（例如[]*v1.Pod），使用klog.KObjSlice。</li></ul></li><li>优先传递结构化的对象，而非object.String()；</li><li>当期望将[]byte类型的对象作为string类型记录时，需要明确使用string(<byte array>)进行转换；</li></ul></li><li>如果使用 <a class=link href=http://github.com/superproj/onex/pkg/log%E6%97%A5%E5%BF%97%E5%8C%85%EF%BC%9A target=_blank rel=noopener>github.com/superproj/onex/pkg/log日志包：open in new window</a><ul><li>要使用结构化的日志记录方式：log.C(ctx).Errorw()、log.C(ctx).Infow()等；</li><li>如果日志能获取到 context.Context 变量，需要使用 log.C() 函数打印，例如：log.C(ctx).Warnw(&ldquo;please enable redis, otherwise the idempotent is invalid&rdquo;)。使用 log.C(ctx) 可以输出必要的 KV，例如：<a class=link href=http://trace.id/ target=_blank rel=noopener>trace.idopen in new window</a>、<a class=link href=http://user.id/ target=_blank rel=noopener>user.idopen in new window</a> 等。</li></ul></li><li>不要使用 Fatal 级别的日志，因为 Fatal 级别的日志会调用 os.Exit(255) 导致日志退出。如果确实需要退出，请先打印 Error 级别的日志，在调用 os.Exit(255) 显示退出程序；</li><li>不要使用 Panic 级别的日志，这会导致程序 Panic，造成服务不稳定。如果程序需要 Panic，可以通过返回 error，并处理改 error 来达到相同的目的；</li><li>线上日志至少要保留 15 天，因为异常日志具有以 周 为频次发生的特点，保留 15 天，可以帮助你在排障时，有日志可以查询；</li><li>在 Debug、排障过程中，持续不断优化日志输出，定期对代码日志进行 review。如果定位问题时间过长则说明日志需要优化。</li></ul><p><strong>提示：</strong></p><ul><li>任何日志事件都可以简单归为错误日志和非错误日志，所以在使用klog记录日志时，只使用了klog.ErrorS 和klog.InfoS；</li><li>在日志消息中，关于开头字母大小写的惯例因开发团队而异。一些团队更喜欢使用大写字母开头，这有助于强调重要性，以及使日志更易读，尤其是在较长的日志行中。而其他团队更倾向于使用小写字母，因为这样的日志看起来更加紧凑和一致；</li><li>无用日志常见情况：<ul><li>能够放在一条日志中的东西放在多条日志中输出；</li><li>预期会发生且能够正常处理的异常，打印一堆无用的堆栈；</li><li>为了开发调试方便而加入的“临时”日志；</li></ul></li><li>日志过少的情况有：<ul><li>请求出错时不能通过日志直接定位问题，需要添加临时日志并重新请求才能定位问题；</li><li>无法确定服务中的后台任务是否按照期望执行；</li><li>无法确定服务的内存数据结构的状态；</li><li>无法确定服务的异常处理逻辑（如重试）是否正常执行；</li><li>无法确定服务启动时配置是否正确加载。</li><li>&mldr;</li></ul></li></ul><h3 id=建议建议遵循的规范><a href=#%e5%bb%ba%e8%ae%ae%e5%bb%ba%e8%ae%ae%e9%81%b5%e5%be%aa%e7%9a%84%e8%a7%84%e8%8c%83>#</a>
【建议】建议遵循的规范</h3><ul><li>请遵循日志打印基本原则：日志信息要简明扼要、易理解、易搜索，并包含排障所需的上下文<ul><li>失败日志建议格式为 Failed to &lt;动词> + &lt;一些事>，例如：log.Errorw(err, &ldquo;Failed to initialize casbin adapter&rdquo;)；</li><li>成功日志建议格式为 &lt;动词> + &lt;一些事>，例如：log.Infow(&ldquo;Initialize idempotent success&rdquo;)。</li></ul></li><li>共享库，例如：<a class=link href=http://github.com/superproj/onex/pkg/db target=_blank rel=noopener>github.com/superproj/onex/pkg/dbopen in new window</a> 只返回错误，不记录日志。因为共享库可能会用在命令行工具、其他项目中，如果记录日志，势必会造成命令行工具有日志输出，影响使用体验、共享库的日志输出跟其他项目的日志输出格式不一致等问题；</li><li>日志包名字统一为 <a class=link href=http://github.com/superproj/onex/pkg/log target=_blank rel=noopener>github.com/superproj/onex/pkg/logopen in new window</a> 或 <a class=link href=http://k8s.io/klog/v2%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%90%8C%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E4%B8%AD%E6%9C%89%E5%85%B6%E4%BB%96%E5%90%8C%E5%90%8D%E7%9A%84%E6%97%A5%E5%BF%97%E5%8C%85%EF%BC%8C%E9%9C%80%E8%A6%81%E5%B0%86%E5%85%B6%E4%BB%96%E6%97%A5%E5%BF%97%E5%8C%85%E9%87%8D%E5%91%BD%E5%90%8D%EF%BC%8C%E8%80%8C%E4%B8%94%E9%87%8D%E5%91%BD%E5%90%8D%E7%9A%84%E5%90%8D%E5%AD%97%E8%A6%81%E5%9C%A8 target=_blank rel=noopener>k8s.io/klog/v2，如果同一个文件中有其他同名的日志包，需要将其他日志包重命名，而且重命名的名字要在open in new window</a>中保持一致，例如：kratoslog &ldquo;<a class=link href=http://github.com/go-kratos/kratos/v2/log target=_blank rel=noopener>github.com/go-kratos/kratos/v2/logopen in new window</a>"；</li><li>Error 日志应该在最原始的报错位置打印，一是避免上层代码缺失部分入参，二是避免漏打；</li><li>服务初始化时，成功信息和失败信息都需要打印，影响启动的错误需要 panic，并打印 FATAL 日志；</li><li>打印参数类型已知的情况下，建议按照对应类型格式化方式打印参数；不确定类型可采用 %v；结构体打印可使用 %+v，可将变量名和变量值都打印出来，但需要注意结构体包含指针类型变量，那打印的只是地址信息，因此需要单独打印。</li></ul><h2 id=选择合适的日志级别><a href=#%e9%80%89%e6%8b%a9%e5%90%88%e9%80%82%e7%9a%84%e6%97%a5%e5%bf%97%e7%ba%a7%e5%88%ab>#</a>
选择合适的日志级别</h2><p>不同级别的日志，具有不同的意义，能实现不同的功能，在开发中，我们应该根据目的，在合适的级别记录日志，这里我同样给你一些建议。具体如下表所示：</p><div class=table-wrapper><table><thead><tr><th>日志级别</th><th>描述</th><th>告警级别</th></tr></thead><tbody><tr><td>Debug</td><td>为了获取足够的信息进行 Debug，通常会在 Debug 级别打印很多日志。例如，可以打印整个 HTTP 请求的请求 Body 或者响应 Body。<br>Debug 级别需要打印大量的日志，这会严重拖累程序的性能。并且，Debug 级别的日志，主要是为了能在开发测试阶段更好地 Debug，多是一些不影响现网业务的日志信息。<br>所以，对于 Debug 级别的日志，在服务上线时我们一定要禁止掉。否则，就可能会因为大量的日志导致硬盘空间快速用完，从而造成服务宕机，也可能会影响服务的性能和产品体验。<br>Debug 这个级别的日志可以随意输出，任何你觉得有助于开发、测试阶段调试的日志，都可以在这个级别打印。</td><td>无</td></tr><tr><td>Info</td><td>Info 级别的日志可以记录一些有用的信息，供以后的运营分析，所以 Info 级别的日志不是越多越好，也不是越少越好，应以满足需求为主要目标。一些关键日志，可以在 Info 级别记录，但如果日志量大、输出频度过高，则要考虑在 Debug 级别记录。<br>现网的日志级别一般是 Info 级别，为了不使日志文件占满整个磁盘空间，在记录日志时，要注意避免产生过多的 Info 级别的日志。例如，在 for 循环中，就要慎用 Info 级别的日志。</td><td>无</td></tr><tr><td>Warn</td><td>一些警告类的日志可以记录在 Warn 级别，Warn 级别的日志表示遇到了预期之内的错误，并且已经进行了处理，不会影响主要功能。像这些日志，就需要你关注起来。Warn 更多的是业务级别的警告日志。</td><td>Lark</td></tr><tr><td>Error</td><td>Error 级别的日志告诉我们程序执行出错，这些错误肯定会影响到程序的执行结果，例如请求失败、创建资源失败等。要记录每一个发生错误的日志，避免日后排障过程中这些错误被忽略掉。大部分的错误可以归在 Error 级别</td><td>Lark 转电话</td></tr><tr><td>Panic</td><td>Panic 级别的日志在实际开发中很少用，通常只在需要错误堆栈，或者不想因为发生严重错误导致程序退出，而采用 defer 处理错误时使用</td><td>Lark + 电话</td></tr><tr><td>Fatal</td><td>Fatal 是最高级别的日志，这个级别的日志说明问题已经相当严重，严重到程序无法继续运行，通常是系统级的错误。在开发中也很少使用，除非我们觉得某个错误发生时，整个程序无法继续运行</td><td>Lark + 电话</td></tr></tbody></table></div><p>根据的日志规范 Panic、Fatal 级别的日志不需要打印，如果需要，可以使用Error 级别的日志 + os.Exit() 进行处理。</p><p>通常， 为了能够及时发现问题并排障，在发生错误日志时，要告警通知到相关的研发或运维，上述表格，也针对不同的日志级别，给出了告警级别，供你参考。</p><blockquote><p>提示：Lark 指代飞书办公软件。</p></blockquote><p><strong>日志级别选择图：</strong>
这里用一张图来总结下，如何选择 Debug、Info、Warn、Error、Panic、Fatal 这几种日志级别。</p><p><img src="https://cdn.nlark.com/yuque/0/2024/png/43447143/1713257876347-befa94ca-2330-403c-8c8e-0e61eba99c35.png#averageHue=%23f0f0f0&amp;clientId=u86c1e48d-415c-4&amp;from=paste&amp;id=ucd1808f5&amp;originHeight=812&amp;originWidth=1920&amp;originalType=url&amp;ratio=1.75&amp;rotation=0&amp;showTitle=true&amp;status=done&amp;style=none&amp;taskId=uc89bb048-8134-40fd-9cbc-7c79f7ed8ec&amp;title=%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB%E9%80%89%E6%8B%A9%E5%9B%BE" loading=lazy alt=日志级别选择图></p><h2 id=日志打印时机><a href=#%e6%97%a5%e5%bf%97%e6%89%93%e5%8d%b0%e6%97%b6%e6%9c%ba>#</a>
日志打印时机</h2><p>在打印日志时，要选择合适的时机进行打印，不能随便打印。</p><h3 id=建议打印时机><a href=#%e5%bb%ba%e8%ae%ae%e6%89%93%e5%8d%b0%e6%97%b6%e6%9c%ba>#</a>
建议打印时机</h3><p>日志主要是用来定位问题的，所以整体来说，我们要在有需要的地方打印日志。那么具体是哪些地方呢？我给你几个建议。</p><ul><li>打印程序的配置参数：系统在启动过程中通常会首先读启动参数，可以在系统启动后将这些参数输出到日志中，方便确认系统是按照期望的参数启动的；</li><li>网络通信部分：发送请求前、收到请求结果均应打印 Info 级别的日志。根据我的研发经验，如果你的程序调用了第三方组件，在排障时，需要提供给第三方组件的研发/运维足够的上下文，帮助复现问题，才会得到他们及时有效的支持，所以这里建议在请求第三方接口时，至少要记录请求包、返回包、URL 等信息。注意，如果请求包和返回包很大，需谨慎打印；</li><li>在分支语句处打印日志：在分支语句处打印日志，可以判断出代码走了哪个分支，有助于判断请求的下一跳，继而继续排查问题；</li><li>写操作必须打印日志：写操作最可能会引起比较严重的业务故障，写操作打印日志，可以在出问题时找到关键信息；</li><li>非预期执行时打印日志：如果程序走到了跟我们预期不一样的分支，需要打印日志。例如：正常情况下，服务的某个状态应该是 Running 的，但真实的状态是 Pending 的，这种异常的状态，很可能会带来问题，后期可能需要定位排障，这时候可以打印相关日志；</li><li>后台定期执行的任务：如定期更新缓存的任务，可以记录任务开始时间，任务结束时间，更新了多少条缓存配置等等，这样可以掌握定期执行的任务的状态；</li><li>业务流程关键节点：我们经常会面对流程比较复杂的业务流程，在整个流程的关键节点上，可以记录下日志，例如，当进行物品交换时，可以将要交换的物品打印出来；</li><li>数据状态变化时：服务端程序的最核心的逻辑就是维护数据状态的变化，因此，在状态有变化的时候，可以记录下日志，例如，订单从创建状态变为已支付状态时，可以记录日志；</li><li>在错误产生的最原始位置打印日志：对于嵌套的 Error，可在 Error 产生的最初位置打印 Error 日志，上层如果不需要添加必要的信息，可以直接返回下层的 Error。我给你举个例子：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/golang/glog&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>glog</span><span class=p>.</span><span class=nf>Flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>loadConfig</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>glog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>loadConfig</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>decodeConfig</span><span class=p>()</span> <span class=c1>// 直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>decodeConfig</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>readConfig</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;could not decode configuration data for user %s: %v&#34;</span><span class=p>,</span> <span class=s>&#34;colin&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span> <span class=c1>// 添加必要的信息，用户名称
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>readConfig</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>glog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;read: end of input.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;read: end of input&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过在最初产生错误的位置打印日志，我们可以很方便地追踪到日志的根源，进而在上层追加一些必要的信息。这可以让我们了解到该错误产生的影响，有助于排障。另外，直接返回下层日志，还可以减少重复的日志打印。</p><p>当代码调用第三方包的函数，且第三方包函数出错时，会打印错误信息。比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Chdir</span><span class=p>(</span><span class=s>&#34;/root&#34;</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;change dir failed: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=不建议打印时机><a href=#%e4%b8%8d%e5%bb%ba%e8%ae%ae%e6%89%93%e5%8d%b0%e6%97%b6%e6%9c%ba>#</a>
不建议打印时机</h3><p>当然，在记录日志时，也有有一些地方是不需要记录日志的，这些地方建议如下：</p><ul><li>在循环中打印日志要慎重：如果循环次数过多，会导致打印大量的日志，严重拖累代码的性能，建议的办法是在循环中记录要点，在循环外面总结打印出来；</li><li>QPS 特别高的接口谨慎打印日志：对于 QPS 特别高的接口，要谨慎选择是否打印日志或者少打印日志，否则可能会影响接口的性能和 CPU 的负载。</li></ul><h2 id=日志级别设置规范><a href=#%e6%97%a5%e5%bf%97%e7%ba%a7%e5%88%ab%e8%ae%be%e7%bd%ae%e8%a7%84%e8%8c%83>#</a>
日志级别设置规范</h2><ul><li>项目刚刚上线可将日志级别设置为 Debug 级别：<ul><li><a class=link href=http://github.com/superproj/onex/pkg/log target=_blank rel=noopener>github.com/superproj/onex/pkg/logopen in new window</a> 设置 level 为 debug；</li><li><a class=link href=http://k8s.io/klog/v2 target=_blank rel=noopener>k8s.io/klog/v2open in new window</a> 设置 -v 为 4。</li></ul></li><li>如果项目经过一段时间的运行，达到一种很稳定的状态，为了不影响性能，需要设置日志级别为 Info：<ul><li><a class=link href=http://github.com/superproj/onex/pkg/log target=_blank rel=noopener>github.com/superproj/onex/pkg/logopen in new window</a> 设置 level 为 info；</li><li><a class=link href=http://k8s.io/klog/v2 target=_blank rel=noopener>k8s.io/klog/v2open in new window</a> 设置 -v 为 2。</li></ul></li><li>测试/开发环境可以设置日志级别为 Debug 级别：<ul><li><a class=link href=http://github.com/superproj/onex/pkg/log target=_blank rel=noopener>github.com/superproj/onex/pkg/logopen in new window</a> 设置 level 为 debug；</li><li><a class=link href=http://k8s.io/klog/v2 target=_blank rel=noopener>k8s.io/klog/v2open in new window</a> 设置 -v 为 4。</li></ul></li></ul><h2 id=日志格式设置规范><a href=#%e6%97%a5%e5%bf%97%e6%a0%bc%e5%bc%8f%e8%ae%be%e7%bd%ae%e8%a7%84%e8%8c%83>#</a>
日志格式设置规范</h2><ul><li>线上日志为了便于日志采集工具采集，需要设置为 JSON 格式；</li><li>开发、测试环境的日志，可以根据需要设置为TEXT 或 JSON 格式。</li></ul><h2 id=日志打印检查><a href=#%e6%97%a5%e5%bf%97%e6%89%93%e5%8d%b0%e6%a3%80%e6%9f%a5>#</a>
日志打印检查</h2><p>Kubernetes 提供了 <a class=link href=https://github.com/kubernetes-sigs/logtools/tree/main/logcheck target=_blank rel=noopener>logcheckopen in new window</a> 工具，来检查 Kubernetes 中的日志记录是否符合规范。你也可以安装，并检查，命令如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ go install sigs.k8s.io/logtools/logcheck@latest
</span></span><span class=line><span class=cl>$ logcheck -check-contextual ${ONEX_ROOT}/...
</span></span><span class=line><span class=cl>$ logcheck -check-structured ${ONEX_ROOT}/...
</span></span></code></pre></td></tr></table></div></div><p>${ONEX_ROOT}为根目录，你可以根据需要修改检查目录。</p><blockquote><p>提示：logcheck工具建议可以了解下，真正的项目开发中，并不实用，尤其不适合集成在 CI 流程中，作为项目发布的强制规范检查。因为很多代码确实难以，也不需要完全遵循logcheck工具制定的规范。</p></blockquote><h2 id=其他日志规范参考><a href=#%e5%85%b6%e4%bb%96%e6%97%a5%e5%bf%97%e8%a7%84%e8%8c%83%e5%8f%82%e8%80%83>#</a>
其他日志规范参考</h2><ul><li>Kubernetes 日志记录规范：<a class=link href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/logging.md#what-method-to-use target=_blank rel=noopener>Loggingopen in new window</a>；</li><li><a class=link href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/migration-to-structured-logging.md target=_blank rel=noopener>Structured and Contextual Logging migration instructions</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/logs/>Logs</a>
<a href=/tags/golang/>Golang</a></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 Apr 02, 2024 19:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/rest-specification/><div class=article-image><img src=/p/rest-specification/cover.2626493133906247fd9fb5824e5c1593_hu5459c0360c2b0cb7a147d2df0eb350ca_952087_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post REST 接口规范" data-key=rest-specification data-hash="md5-JiZJMTOQYkf9n7WCTlwVkw=="></div><div class=article-details><h2 class=article-title>REST 接口规范</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//xiuwei.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 哈皮的自言自语</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script>document.querySelectorAll(".powerby").forEach(e=>{e.style.display="none"})</script></body></html>